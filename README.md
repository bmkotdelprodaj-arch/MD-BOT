# Проект Degustation Analyzer (MD-BOT)

Проект предназначен для автоматизации анализа и обработки отчетов дегустаций сырной продукции с использованием Google Sheets и Telegram. Система собирает данные из утренних и вечерних анкет в Google Sheets, обрабатывает пары отчетов, генерирует детальные и сводные отчеты, и отправляет их через Telegram бота пользователям.

---

## Основные возможности

- Автоматический сбор новых отчетов из Google Sheets.
- Нормализация адресов и ФИО для корректного сопоставления отчетов.
- Вычисление продаж по видами сыра, эффективности дегустаций.
- Отправка детальных отчетов и ежедневных сводных статистик в Telegram.
- Взаимодействие с пользователем через текстовые и интерактивные меню в Telegram.
- Поддержка локального запуска с планировщиком и webhook для продакшен-развертывания.

---

## Ключевые модули и за что они отвечают (AIL)

### 1. `main.py`  
Основной управляющий модуль проекта.  
- Инициализирует сервисы конфигурации, Google Sheets, обработки данных и Telegram.  
- Реализует класс `DegustationAnalyzer` с методами для периодической проверки новых отчетов, генерации сводных отчетов и отправки сообщений.  
- Запускает цикл планировщика локально или при работе на Render задаёт Flask webhook.

### 2. `config.py`  
Хранит ключевые настройки проекта и логики.  
- Загружает и нормализует учетные данные Google из переменных окружения или файла.  
- Определяет идентификаторы Google Sheets, колонки для утренних и вечерних отчетов.  
- Содержит параметры бота (токены, ID чатов), а также константы для типов сыров и пороговых значений.

### 3. `google_sheets.py`  
Сервис взаимодействия с Google Sheets через API.  
- Производит аутентификацию с помощью сервисного аккаунта.  
- Кэширует клиент gspread для оптимизации.  
- Обеспечивает получение всех данных на листе и фильтрацию новых записей по временной метке.

### 4. `data_processor.py`  
Бизнес-логика обработки и анализа данных дегустаций.  
- Нормализует адреса и имена сотрудников (используя `AddressNormalizer`).  
- Находит и сопоставляет пары утренних и вечерних отчетов.  
- Рассчитывает продажи по каждому виду сыра, количество посетителей и эффективность.  
- Создаёт детальные и сводные отчеты для отправки пользователю.

### 5. `telegram_bot.py`  
Синхронный Telegram бот для взаимодействия с пользователем.  
- Отправляет и редактирует сообщения и меню с инлайн кнопками.  
- Обрабатывает callback запросы с выбором типа отчетов и фильтров.  
- Форматирует текстовые отчеты для представления в Telegram.

### 6. `telegram_ptb_bot.py`  
Асинхронная реализация Telegram бота на библиотеке `python-telegram-bot`.  
- Обеспечивает интерактивное меню с динамическим удалением устаревших сообщений.  
- Обрабатывает команды, callback-запросы, и формирует отчеты асинхронно для улучшенной отзывчивости.

### 7. `telegram_webhook.py`  
Flask-приложение для работы бота через webhook (используется в продакшене).  
- Принимает и обрабатывает POST-запросы Telegram обновлений.  
- Делегирует обработку обновлений классу бота.  
- Содержит маршруты для проверки статуса и ручного запуска проверки отчетов.

### 8. `google_auth_service.py`  
Сервис аутентификации Google сервисного аккаунта.  
- Загружает, валидирует и обрабатывает private_key.  
- Проверяет системное время синхронизации.  
- Создаёт валидные credentials для API Google Sheets и выполняет тестовый запрос.

### 9. `address_normalizer.py`  
Утилита для нормализации и сравнения адресов.  
- Использует базу канонических адресов и правила замены для стандартизации.  
- Оценивает схожесть адресов через rapidfuzz с порогом совпадения.

---

## Запуск проекта

- Локально проект можно запустить через `main.py`, который запустит цикл периодической проверки новых отчетов и отправки сообщений.
- В продакшене рекомендуется использовать webhook через Flask-приложение `telegram_webhook.py`.
- Все необходимые параметры (токены, id, credentials) задаются через переменные окружения.

---

## Требования

Из файла `requirements.txt` установите все зависимости, включая:

- gspread
- pandas
- rapidfuzz
- requests
- python-telegram-bot
- Flask
- google-auth, google-api-python-client
- cryptography
- schedule
- dotenv

---

## Структура проекта

```
├── main.py                  # Основной модуль анализа и планировщик
├── config.py                # Конфигурация и параметры
├── google_sheets.py         # Работа с Google Sheets API
├── data_processor.py        # Обработка, сравнение и анализ отчетов
├── telegram_bot.py          # Синхронный Telegram бот
├── telegram_ptb_bot.py      # Асинхронный Telegram бот (python-telegram-bot)
├── telegram_webhook.py      # Flask приложение для webhook Telegram
├── google_auth_service.py   # Аутентификация Google API
├── address_normalizer.py    # Нормализация и сравнение адресов
├── requirements.txt         # Зависимости
└── README.md                # Этот файл
```

---

README подготовлен на основе анализа кодовой базы для понимания архитектуры и ролей основных компонентов проекта.
